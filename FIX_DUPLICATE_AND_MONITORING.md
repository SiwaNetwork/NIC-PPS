# Исправление проблем с дублированием NIC устройств и мониторингом трафика

## Описание проблем

1. **Дублирование устройств**: При вводе настроек в GUI, CLI и Web версиях создавались копии NIC устройств вместо обновления существующих.
2. **Неработающий мониторинг трафика**: Функция мониторинга трафика не показывала актуальную статистику и скорость передачи данных.

## Внесенные исправления

### 1. Исправление дублирования устройств

#### Проблема
При каждом обновлении списка устройств в `TimeNICManager` не очищался существующий список, что приводило к накоплению дубликатов.

#### Решение
В файле `core/timenic_manager.py`:

1. Добавлена очистка списков перед обнаружением устройств:
```python
def _discover_timenics(self):
    """Обнаружение TimeNIC карт"""
    try:
        # Очищаем список перед новым обнаружением
        self.timenic_list = []
        # ... остальной код
```

2. Добавлен метод `refresh()` для обновления списка устройств:
```python
def refresh(self):
    """Обновление списка TimeNIC карт и PTP устройств"""
    self._discover_timenics()
    self._discover_ptp_devices()
```

3. Обновлены интерфейсы для использования метода `refresh()`:
   - **GUI** (`gui/main.py`): Добавлен вызов `self.timenic_manager.refresh()` в методе `refresh_data()`
   - **Web** (`web/app.py`): Добавлен вызов `timenic_manager.refresh()` в API методах и цикле мониторинга

### 2. Исправление мониторинга трафика

#### Проблема
Отсутствовала функция мониторинга трафика в реальном времени с расчетом скорости передачи данных.

#### Решение
В файле `core/timenic_manager.py`:

1. Расширен метод `get_statistics()` для получения полной статистики:
```python
# Добавлено получение пакетов и ошибок
result = subprocess.run(["cat", f"/sys/class/net/{interface}/statistics/rx_packets"], 
                      capture_output=True, text=True)
# ... и другие метрики
```

2. Добавлен новый метод `monitor_traffic()`:
```python
def monitor_traffic(self, interface: str, callback=None, interval: int = 1):
    """Мониторинг трафика в реальном времени"""
    # Вычисляет скорость передачи данных
    # Поддерживает callback для обновления UI
    # Обновляет информацию о TimeNIC в реальном времени
```

3. Обновлен CLI интерфейс (`cli/timenic_cli.py`):
   - Использует новый метод `monitor_traffic()`
   - Отображает скорость в Mbps и PPS (пакеты в секунду)
   - Показывает ошибки передачи

## Тестирование

Создан тестовый скрипт `test_fixes.py` для проверки исправлений:

```bash
# Запуск тестов (рекомендуется с правами root)
sudo python3 test_fixes.py
```

Тесты проверяют:
1. Отсутствие дублирования устройств при многократном обновлении
2. Работу мониторинга трафика и обновление статистики
3. Применение настроек PPS без создания дубликатов

## Использование

### CLI
```bash
# Мониторинг TimeNIC с обновлением каждую секунду
python run.py --cli timenic monitor eth0 --interval 1
```

### GUI
- Кнопка "Обновить" теперь корректно обновляет список без дубликатов
- Мониторинг показывает актуальную скорость трафика

### Web
- API `/api/timenics` возвращает актуальный список без дубликатов
- WebSocket мониторинг передает данные о скорости трафика в реальном времени

## Результат

1. ✅ Устранена проблема создания дубликатов NIC устройств
2. ✅ Реализован полноценный мониторинг трафика с отображением:
   - Скорости передачи данных (Mbps)
   - Количества пакетов в секунду (PPS)
   - Ошибок передачи
   - Температуры и других параметров TimeNIC